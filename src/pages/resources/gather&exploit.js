import React, { useState, useEffect } from "react"
import { Link } from "gatsby"
import Layout from "../../components/layout"
import Seo from "../../components/seo"
import { Bar } from 'react-chartjs-2'
import { Chart as ChartJS, CategoryScale, LinearScale, BarElement, Title, Tooltip, Legend } from 'chart.js'

ChartJS.register(CategoryScale, LinearScale, BarElement, Title, Tooltip, Legend)

const GatherAndExploitPage = () => {
  const [resourcesData, setResourcesData] = useState(null)
  const [shipsData, setShipsData] = useState(null) // 定義 shipsData 用於存儲船艦數據
  const [expandedShip, setExpandedShip] = useState(null) // 用於控制船艦載重的展開
  const [expandedEfficiency, setExpandedEfficiency] = useState(null) // 控制生產效率的展開
  const [expandedPlanet, setExpandedPlanet] = useState(null) // 用於控制行星種類展開

  useEffect(() => {
    // 加載資源數據
    import("../../data/resourcesData.json").then(data => {
      setResourcesData(data)
    })
    
    // 加載船艦數據
    import("../../data/shipsData.json").then(data => {
      setShipsData(data) // 確保正確加載 shipsData
    })
  }, [])

  // 定義 toggleShipExpand 函數來控制展開/折疊
  const toggleShipExpand = (shipType) => {
    if (expandedShip === shipType) {
      setExpandedShip(null) // 如果再次點擊已展開的船艦，則折疊
    } else {
      setExpandedShip(shipType) // 展開當前船艦
    }
  }

  // 定義 toggleEfficiency 函數來控制生產效率的展開/收合
  const toggleEfficiency = (index) => {
    if (expandedEfficiency === index) {
      setExpandedEfficiency(null) // 如果再次點擊已展開的生產效率，則折疊
    } else {
      setExpandedEfficiency(index) // 展開當前的生產效率
    }
  }

  // 定義 toggleExpand 函數來控制行星種類的展開/收合
  const toggleExpand = (index) => {
    if (expandedPlanet === index) {
      setExpandedPlanet(null) // 如果再次點擊已展開的行星種類，則折疊
    } else {
      setExpandedPlanet(index) // 展開當前行星種類
    }
  }

  // 繪製護衛艦、驅逐艦、巡洋艦的載重圖表
  const getLoadData = (shipType) => {
    return shipsData ? shipsData[shipType].map(ship => ship.load) : []
  }

  // 三個單獨的載重圖表
  const frigateLoadData = {
    labels: shipsData ? shipsData.frigate.map(ship => `Level ${ship.level}`) : [],
    datasets: [{
      label: '護衛艦載重',
      data: getLoadData('frigate'),
      backgroundColor: 'rgba(75, 192, 192, 0.6)',
    }]
  }

  const destroyerLoadData = {
    labels: shipsData ? shipsData.destroyer.map(ship => `Level ${ship.level}`) : [],
    datasets: [{
      label: '驅逐艦載重',
      data: getLoadData('destroyer'),
      backgroundColor: 'rgba(153, 102, 255, 0.6)',
    }]
  }

  const cruiserLoadData = {
    labels: shipsData ? shipsData.cruiser.map(ship => `Level ${ship.level}`) : [],
    datasets: [{
      label: '巡洋艦載重',
      data: getLoadData('cruiser'),
      backgroundColor: 'rgba(255, 159, 64, 0.6)',
    }]
  }

  // 比較單位領導力載重
  const unitLoadData = {
    labels: ['護衛艦', '驅逐艦', '巡洋艦'],
    datasets: [{
      label: '單位領導力載重',
      data: [3, 10, 30], // 單位領導力的載重
      backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)'],
    }]
  }

  return (
    <Layout>
      <h1>資源採集與開發</h1>
      <p>
        在這遊戲中，可以透過資源採集與開發分別在礦場與行星平台獲取
        <Link to="/resources">資源</Link>（當然，你也可以透過攻擊別人來獲取資源）
      </p>

      <h2>採集與開發之艦船配置</h2>
      <p>不同的艦船種類的載重都不同。如同<Link to="/ships">船艦頁面</Link>的載重比較所說：</p>
      <ul>
        <li>驅逐艦有最高載重</li>
        <li>巡洋艦與護衛艦之間的載重差距會隨階數增加而變大</li>
      </ul>

      <h2>艦船載重圖表</h2>
      {/* 護衛艦、驅逐艦、巡洋艦的載重圖表 */}
      <Bar data={frigateLoadData} options={{ responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: '護衛艦載重圖表' } } }} />
      <Bar data={destroyerLoadData} options={{ responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: '驅逐艦載重圖表' } } }} />
      <Bar data={cruiserLoadData} options={{ responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: '巡洋艦載重圖表' } } }} />
      
      <h2>單位領導力載重比較圖表</h2>
      <Bar data={unitLoadData} options={{ responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: '單位領導力載重比較' } } }} />

      <p>以下是各艦船載重數據：</p>
      {/* 繪製載重表格 */}
      {shipsData ? (
        <div>
          <table>
            <thead>
              <tr>
                <th>艦種</th>
                <th>載重數據</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>護衛艦</td>
                <td>
                  <button
                    onClick={() => toggleShipExpand('frigate')}
                    style={{ cursor: 'pointer', color: 'blue', background: 'none', border: 'none', padding: '0', textDecoration: 'underline' }}
                    aria-expanded={expandedShip === 'frigate' ? "true" : "false"}
                  >
                    {expandedShip === 'frigate' ? "收起" : "展開"}
                  </button>
                </td>
              </tr>
              {expandedShip === 'frigate' && (
                <tr>
                  <td colSpan="2">
                    <table>
                      <thead>
                        <tr>
                          <th>等級</th>
                          <th>艦船名稱</th>
                          <th>載重</th>
                        </tr>
                      </thead>
                      <tbody>
                        {shipsData.frigate.map((ship, idx) => (
                          <tr key={idx}>
                            <td>{ship.level}</td>
                            <td>{ship.ship_name}</td>
                            <td>{ship.load}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </td>
                </tr>
              )}

              <tr>
                <td>驅逐艦</td>
                <td>
                  <button
                    onClick={() => toggleShipExpand('destroyer')}
                    style={{ cursor: 'pointer', color: 'blue', background: 'none', border: 'none', padding: '0', textDecoration: 'underline' }}
                    aria-expanded={expandedShip === 'destroyer' ? "true" : "false"}
                  >
                    {expandedShip === 'destroyer' ? "收起" : "展開"}
                  </button>
                </td>
              </tr>
              {expandedShip === 'destroyer' && (
                <tr>
                  <td colSpan="2">
                    <table>
                      <thead>
                        <tr>
                          <th>等級</th>
                          <th>艦船名稱</th>
                          <th>載重</th>
                        </tr>
                      </thead>
                      <tbody>
                        {shipsData.destroyer.map((ship, idx) => (
                          <tr key={idx}>
                            <td>{ship.level}</td>
                            <td>{ship.ship_name}</td>
                            <td>{ship.load}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </td>
                </tr>
              )}

              <tr>
                <td>巡洋艦</td>
                <td>
                  <button
                    onClick={() => toggleShipExpand('cruiser')}
                    style={{ cursor: 'pointer', color: 'blue', background: 'none', border: 'none', padding: '0', textDecoration: 'underline' }}
                    aria-expanded={expandedShip === 'cruiser' ? "true" : "false"}
                  >
                    {expandedShip === 'cruiser' ? "收起" : "展開"}
                  </button>
                </td>
              </tr>
              {expandedShip === 'cruiser' && (
                <tr>
                  <td colSpan="2">
                    <table>
                      <thead>
                        <tr>
                          <th>等級</th>
                          <th>艦船名稱</th>
                          <th>載重</th>
                        </tr>
                      </thead>
                      <tbody>
                        {shipsData.cruiser.map((ship, idx) => (
                          <tr key={idx}>
                            <td>{ship.level}</td>
                            <td>{ship.ship_name}</td>
                            <td>{ship.load}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      ) : (
        <p>加載中...</p>
      )}

      <br />

      <h2>礦場（表格加上收合功能）</h2>
      {resourcesData ? (
        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '20px' }}>
          {resourcesData.mines.map((mine, index) => (
            <div key={index} style={{ flex: '1 1 300px', minWidth: '300px' }}>
              <h3>{mine.resource}</h3>
              <ul>
                <li>採集解鎖條件：{mine.unlock}</li>
                <li>採集速度：{mine.efficiency}</li>
                <li>
                  等級對應的資源儲量：
                  <table>
                    <thead>
                      <tr>
                        <th style={{ padding: '10px 20px', textAlign: 'left' }}>等級</th>
                        <th style={{ padding: '10px 20px', textAlign: 'left' }}>資源儲量</th>
                      </tr>
                    </thead>
                    <tbody>
                      {mine.levels.map((levelData, idx) => (
                        <tr key={idx}>
                          <td style={{ padding: '8px 20px' }}>{levelData.level}</td>
                          <td style={{ padding: '8px 20px' }}>{levelData.capacity}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </li>
              </ul>
            </div>
          ))}
        </div>
      ) : (
        <p>加載中...</p>
      )}
      <br />

      <h2>行星平台</h2>

      <h3>行星類型</h3>
      <ul>
        <li><Link to="/explore">探索</Link>不同行星類型可獲的豐富獎勵</li>
        <li>不同類型的行星平台可開發出不同種類資源。</li>
      </ul>
      <h3>行星平台資料列表</h3>
      {resourcesData ? (
        <div style={{ display: 'flex', gap: '20px' }}>
          <div style={{ flex: '2' }}>
            <table>
              <thead>
                <tr>
                  <th style={{ padding: '10px 20px', textAlign: 'left' }}>資源種類</th>
                  <th style={{ padding: '10px 20px', textAlign: 'left' }}>資源生產效率</th>
                  <th style={{ padding: '10px 20px', textAlign: 'left' }}>行星種類</th>
                </tr>
              </thead>
              <tbody>
                {resourcesData.planetaryPlatforms.map((platform, index) => (
                  <React.Fragment key={index}>
                    <tr>
                      <td style={{ padding: '8px 20px' }}>{platform.resource}</td>
                      <td style={{ padding: '8px 20px' }}>
                        <button
                          onClick={() => toggleEfficiency(index)}
                          style={{ cursor: 'pointer', color: 'blue', background: 'none', border: 'none', padding: '0', textDecoration: 'underline' }}
                          aria-expanded={expandedEfficiency === index ? "true" : "false"}
                        >
                          {expandedEfficiency === index ? "收起生產效率" : "展開生產效率"}
                        </button>
                      </td>
                      <td style={{ padding: '8px 20px' }}>
                        <button
                          onClick={() => toggleExpand(index)}
                          style={{ cursor: 'pointer', color: 'blue', background: 'none', border: 'none', padding: '0', textDecoration: 'underline' }}
                          aria-expanded={expandedPlanet === index ? "true" : "false"}
                        >
                          {expandedPlanet === index ? "收起" : "展開"}
                        </button>
                      </td>
                    </tr>
                    {expandedPlanet === index && (
                      <tr>
                        <td colSpan="3" style={{ padding: '8px 20px' }}>
                          <p>行星種類:</p>
                          <ul style={{ listStyleType: 'none', padding: 0 }}>
                            {platform.planetTypes.map((type, idx) => (
                              <li key={idx} style={{ display: 'inline', marginRight: '20px' }}>{type}</li>
                            ))}
                          </ul>
                        </td>
                      </tr>
                    )}
                  </React.Fragment>
                ))}
              </tbody>
            </table>
          </div>

          <div style={{ flex: '1', borderLeft: '1px solid #ccc', paddingLeft: '20px' }}>
            {expandedEfficiency !== null && (
              <div>
                <h3>{resourcesData.planetaryPlatforms[expandedEfficiency].resource} 生產效率</h3> {/* 添加資源名稱 */}
                <table>
                  <thead>
                    <tr>
                      <th style={{ padding: '10px 20px', textAlign: 'left' }}>等級</th>
                      <th style={{ padding: '10px 20px', textAlign: 'left' }}>效率</th>
                    </tr>
                  </thead>
                  <tbody>
                    {resourcesData.planetaryPlatforms[expandedEfficiency].levels.map((levelData, idx) => (
                      <tr key={idx}>
                        <td style={{ padding: '8px 20px' }}>{levelData.level}</td>
                        <td style={{ padding: '8px 20px' }}>{levelData.efficiency}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      ) : (
        <p>加載中...</p>
      )}

    </Layout>
  )
}

export const Head = () => (
  <Seo 
    title="挖掘資源" 
    description="這個頁面教你最基本的資源獲取方式"
    lang="zh-Hant"
  />
)

export default GatherAndExploitPage
